#!/usr/bin/python
#
# I/R Remote Control input
#
# (c) David Haworth

import os
import select

irrc_dev = '/dev/hidraw0'

irrc_map = {
	'\x06\x02\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00'	:	'moon',
	'\x04\x01\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'	:	'home',
	'\x05\x00 \x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'		:	'|<',
	'\x05\x00\x01\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'>/||',
	'\x05\x00\x10\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'>|',
	'\x05\x00\x08\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'<<',
	'\x05\x00@\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'		:	'stop',
	'\x05\x00\x04\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'>>',
	'\x01\x00\x00\x00\x00R\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'up',
	'\x01\x00\x00\x00\x00P\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'left',
	'\x01\x00\x00\x00\x00(\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'ok',
	'\x01\x00\x00\x00\x00O\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'right',
	'\x01\x00\x00\x00\x00Q\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'down',
	'\x05\x01\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'vol+',
	'\x05\x08\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'ch+',
	'\x05\x02\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'vol-',
	'\x01\x00\x00\x00\x00*\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'back',
	'\x05\x10\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'ch-',
	'\x01\x00\x00\x00\x00\x1e\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'	:	'1',
	'\x01\x00\x00\x00\x00\x1f\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'	:	'2',
	'\x01\x00\x00\x00\x00 \x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'3',
	'\x01\x00\x00\x00\x00!\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'4',
	'\x01\x00\x00\x00\x00"\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'5',
	'\x01\x00\x00\x00\x00#\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'6',
	'\x01\x00\x00\x00\x00$\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'7',
	'\x01\x00\x00\x00\x00%\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'8',
	'\x01\x00\x00\x00\x00&\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'		:	'9',
	'\x02\x10\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00'	:	'fullscreen',
	'\x01\x00\x00\x00\x00\'\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'	:	'0',
	'\x04\x00\x04\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'	:	'menu',
	'\x05\x00\x02\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'rec',
	'\x04\x00 \x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'		:	'txt',
	'\x05\x04\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00'	:	'mute',
	'\x04\x02\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'	:	'tv',
	'\x03\x04\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00'	:	'radio',
	'\x04\x08\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'	:	'red',
	'\x04\x10\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'	:	'green',
	'\x04 \x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'		:	'blue',
	'\x04\x80\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'	:	'yellow'	}

class IrRc:
	def __init__(self):
		self.irrc_present = False
		self.Open()

	def Open(self):
		if os.path.exists(irrc_dev):
			try:
				os.system('sudo chmod +r '+irrc_dev)
				self.irrc = open(irrc_dev, 'r')
				self.irrc_present = True
			except:
				self.irrc_present = False

	def Scan(self):
		if not self.irrc_present:
			self.Open()

	def GetEvent(self):					# Called frequently to read keys from remote control.
		k = ''
		if self.irrc_present:
			try:
				rrdy, wrdy, xrdy = select.select([self.irrc], [], [], 0)
				if rrdy:
					q = self.irrc.read(16)
					k = irrc_map[q]
			except KeyError:
				print 'Unknown keycode'
			except IOError:
				self.irrc_present = False
				try:
					self.irrc.close()
				except:
					pass
		return k
